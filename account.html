<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Account - Harvey's Blog</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- Complete favicon set -->
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="shortcut icon" href="favicon.ico">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
</head>
<body>
    <header>
        <div class="container">
            <h1>üë§ My Account</h1>
            <nav>
                <a href="index.html">Home</a>
                <a href="travel.html">Travel</a>
                <a href="about.html">About</a>
                <a href="write.html">Write</a>
                <a href="my-posts.html">My Posts</a>
                <a href="contact.html">Contact</a>
                <a href="admin.html" style="color: #fbbf24;">Admin</a>
            </nav>
        </div>
    </header>

    <main class="container">
        <!-- Login/Register Section -->
        <div id="auth-section" class="post">
            <h2>üîê Account Access</h2>
            
            <!-- Login Form -->
            <div id="login-form" class="auth-form">
                <h3>Login to Your Account</h3>
                <div class="form-group">
                    <label for="login-username">Username:</label>
                    <input type="text" id="login-username" placeholder="Enter your username">
                </div>
                <div class="form-group">
                    <label for="login-password">Password:</label>
                    <input type="password" id="login-password" placeholder="Enter your password">
                </div>
                <button onclick="loginUser()" class="btn-primary">üîë Login</button>
                <button onclick="showRegisterForm()" class="btn-secondary">üìù Create New Account</button>
            </div>

            <!-- Register Form -->
            <div id="register-form" class="auth-form" style="display: none;">
                <h3>Create New Account</h3>
                <div class="form-group">
                    <label for="register-username">Username:</label>
                    <input type="text" id="register-username" placeholder="Choose a username">
                </div>
                <div class="form-group">
                    <label for="register-email">Email:</label>
                    <input type="email" id="register-email" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="register-password">Password:</label>
                    <input type="password" id="register-password" placeholder="Choose a password">
                </div>
                <div class="form-group">
                    <label for="register-confirm">Confirm Password:</label>
                    <input type="password" id="register-confirm" placeholder="Confirm your password">
                </div>
                <button onclick="registerUser()" class="btn-primary">üöÄ Create Account</button>
                <button onclick="showLoginForm()" class="btn-secondary">‚Üê Back to Login</button>
            </div>
        </div>

        <!-- Account Dashboard -->
        <div id="account-dashboard" style="display: none;">
            <!-- Profile Section -->
            <div class="post">
                <h2>üë§ Profile Information</h2>
                <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
                    <div class="profile-avatar" onclick="editAvatar()" style="cursor: pointer; position: relative;">
                        <div id="user-avatar" style="width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: bold; color: white; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: 3px solid rgba(255,255,255,0.3); transition: all 0.3s ease; background-size: cover; background-position: center;">
                            HB
                        </div>
                        <div style="position: absolute; bottom: 0; right: 0; background: #4ECDC4; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; border: 2px solid white;">‚úèÔ∏è</div>
                    </div>
                    <div>
                        <h3 id="user-display-name" style="margin: 0; color: white;">Loading...</h3>
                        <p id="user-email" style="color: rgba(255,255,255,0.8); margin: 5px 0;">Loading...</p>
                        <p id="user-join-date" style="color: rgba(255,255,255,0.6); font-size: 0.9em; margin: 0;">Member since: Loading...</p>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px;">
                    <div class="stat-item" style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
                        <span class="stat-number" id="user-posts-count">0</span>
                        <span class="stat-label">Posts Written</span>
                    </div>
                    <div class="stat-item" style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
                        <span class="stat-number" id="user-comments-count">0</span>
                        <span class="stat-label">Comments Made</span>
                    </div>
                    <div class="stat-item" style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
                        <span class="stat-number" id="user-likes-received">0</span>
                        <span class="stat-label">Likes Received</span>
                    </div>
                </div>
            </div>

            <!-- Account Settings -->
            <div class="post">
                <h3>‚öôÔ∏è Account Settings</h3>
                <div class="form-group">
                    <label for="edit-username">Username:</label>
                    <input type="text" id="edit-username" placeholder="Username">
                </div>
                <div class="form-group">
                    <label for="edit-email">Email:</label>
                    <input type="email" id="edit-email" placeholder="Email">
                </div>
                <div class="form-group">
                    <label for="edit-bio">Bio:</label>
                    <textarea id="edit-bio" rows="3" placeholder="Tell us about yourself..."></textarea>
                </div>
                <button onclick="updateProfile()" class="btn-primary">üíæ Save Changes</button>
                <button onclick="changePassword()" class="btn-secondary">üîí Change Password</button>
                <button onclick="logoutUser()" class="btn-secondary" style="background: rgba(220, 53, 69, 0.8);">üö™ Logout</button>
            </div>

            <!-- Recent Activity -->
            <div class="post">
                <h3>üìä Recent Activity</h3>
                <div id="user-activity">
                    <p style="color: rgba(255,255,255,0.8);">Loading your recent activity...</p>
                </div>
            </div>
        </div>

        <!-- Avatar Selection Modal -->
        <div id="avatar-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; backdrop-filter: blur(5px);">
            <div style="display: flex; align-items: center; justify-content: center; height: 100%; padding: 20px;">
                <div style="background: rgba(53, 66, 74, 0.95); backdrop-filter: blur(20px); border-radius: 20px; border: 2px solid rgba(255, 255, 255, 0.2); padding: 40px; max-width: 500px; width: 100%;">
                    <h3 style="color: white; margin-bottom: 20px;">üé® Choose Your Avatar</h3>
                    
                    <!-- Avatar Type Selection -->
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: white; margin-bottom: 10px;">Avatar Type:</h4>
                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <button id="gradient-avatar-btn" onclick="selectAvatarType('gradient')" style="padding: 10px 20px; border-radius: 8px; border: 2px solid #4ECDC4; background: #4ECDC4; color: white; cursor: pointer; font-weight: bold;">üé® Gradient + Text</button>
                            <button id="photo-avatar-btn" onclick="selectAvatarType('photo')" style="padding: 10px 20px; border-radius: 8px; border: 2px solid rgba(255,255,255,0.3); background: transparent; color: white; cursor: pointer; font-weight: bold;">üì∑ Upload Photo</button>
                        </div>
                    </div>

                    <!-- Photo Upload Section -->
                    <div id="photo-upload-section" style="display: none; margin-bottom: 20px;">
                        <h4 style="color: white; margin-bottom: 10px;">Upload Your Photo:</h4>
                        <input type="file" id="avatar-photo-input" accept="image/*" style="display: none;" onchange="handlePhotoUpload(event)">
                        <button onclick="document.getElementById('avatar-photo-input').click()" style="padding: 12px 24px; border-radius: 8px; border: 2px dashed rgba(255,255,255,0.5); background: rgba(255,255,255,0.1); color: white; cursor: pointer; font-weight: bold; width: 100%; margin-bottom: 10px;">
                            üì§ Choose Photo from Device
                        </button>
                        <p style="color: rgba(255,255,255,0.7); font-size: 12px; margin: 5px 0;">Supported: JPG, PNG, GIF (max 2MB)</p>
                        <div id="photo-crop-area" style="display: none; margin-top: 15px;">
                            <p style="color: rgba(255,255,255,0.9); font-size: 14px; margin-bottom: 10px;">
                                üñ±Ô∏è <strong>Drag the circle to position your crop area</strong>
                            </p>
                            <canvas id="photo-canvas" style="border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; max-width: 100%;"></canvas>
                            <div style="margin-top: 10px;">
                                <button onclick="cropPhoto()" style="padding: 8px 16px; border-radius: 6px; border: 1px solid #4ECDC4; background: #4ECDC4; color: white; cursor: pointer; margin-right: 10px;">‚úÇÔ∏è Crop & Use</button>
                                <button onclick="cancelPhotoUpload()" style="padding: 8px 16px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.3); background: transparent; color: white; cursor: pointer;">‚ùå Cancel</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Gradient Backgrounds Section -->
                    <div id="gradient-avatar-section" style="margin-bottom: 20px;">
                        <h4 style="color: white; margin-bottom: 10px;">Background Color:</h4>
                        <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; margin-bottom: 15px;">
                            <div class="gradient-option" data-gradient="linear-gradient(135deg, #667eea 0%, #764ba2 100%)" style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); cursor: pointer; border: 3px solid transparent;"></div>
                            <div class="gradient-option" data-gradient="linear-gradient(135deg, #f093fb 0%, #f5576c 100%)" style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); cursor: pointer; border: 3px solid transparent;"></div>
                            <div class="gradient-option" data-gradient="linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)" style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); cursor: pointer; border: 3px solid transparent;"></div>
                            <div class="gradient-option" data-gradient="linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)" style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); cursor: pointer; border: 3px solid transparent;"></div>
                            <div class="gradient-option" data-gradient="linear-gradient(135deg, #fa709a 0%, #fee140 100%)" style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); cursor: pointer; border: 3px solid transparent;"></div>
                            <div class="gradient-option" data-gradient="linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)" style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); cursor: pointer; border: 3px solid transparent;"></div>
                        </div>
                        
                        <!-- Initials Input -->
                        <h4 style="color: white; margin-bottom: 10px;">Initials:</h4>
                        <input type="text" id="avatar-initials" maxlength="2" placeholder="HB" style="width: 100px; padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; text-align: center; font-size: 18px; font-weight: bold; text-transform: uppercase;">
                    </div>
                    
                    <!-- Preview -->
                    <div style="margin-bottom: 20px; text-align: center;">
                        <h4 style="color: white; margin-bottom: 10px;">Preview:</h4>
                        <div id="avatar-preview" style="width: 80px; height: 80px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 32px; font-weight: bold; color: white; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: 3px solid rgba(255,255,255,0.3); background-size: cover; background-position: center;">
                            HB
                        </div>
                    </div>
                    
                    <div style="text-align: center; display: flex; gap: 10px; justify-content: center;">
                        <button onclick="saveAvatar()" class="btn-primary">üíæ Save Avatar</button>
                        <button onclick="closeAvatarModal()" class="btn-secondary">‚ùå Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="footer-content">
            <p>&copy; 2024 Harvey's Blog. All rights reserved.</p>
        </div>
    </footer>

    <script src="js/firebase-config.js"></script>
    
    <script>
        let currentUser = null;
        let selectedGradient = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
        let currentAvatarType = 'gradient';
        let uploadedPhotoData = null;
        let photoCanvas = null;
        let photoContext = null;

        // Initialize account system
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                checkUserSession();
                setupAvatarEditor();
            }, 1000);
        });

        // Check if user is logged in
        function checkUserSession() {
            const userData = localStorage.getItem('currentUser');
            if (userData) {
                currentUser = JSON.parse(userData);
                showAccountDashboard();
            }
        }

        // Show login form
        function showLoginForm() {
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('register-form').style.display = 'none';
        }

        // Show register form
        function showRegisterForm() {
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('register-form').style.display = 'block';
        }

        // Register new user
        async function registerUser() {
            const username = document.getElementById('register-username').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm').value;

            if (!username || !email || !password) {
                alert('Please fill in all fields');
                return;
            }

            if (password !== confirmPassword) {
                alert('Passwords do not match');
                return;
            }

            if (password.length < 6) {
                alert('Password must be at least 6 characters long');
                return;
            }

            try {
                // Check if username already exists
                const existingUser = await checkUsernameExists(username);
                if (existingUser) {
                    alert('Username already exists. Please choose another one.');
                    return;
                }

                const userData = {
                    id: generateUserId(),
                    username: username,
                    email: email,
                    password: password, // In real app, this should be hashed
                    joinDate: new Date().toISOString(),
                    avatar: {
                        type: 'gradient',
                        background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                        initials: username.substring(0, 2).toUpperCase(),
                        photo: null
                    },
                    bio: '',
                    stats: {
                        postsCount: 0,
                        commentsCount: 0,
                        likesReceived: 0
                    }
                };

                // Save to Firebase or localStorage
                if (window.db) {
                    await window.db.collection('users').doc(userData.id).set(userData);
                } else {
                    const users = JSON.parse(localStorage.getItem('blogUsers') || '[]');
                    users.push(userData);
                    localStorage.setItem('blogUsers', JSON.stringify(users));
                }

                alert('‚úÖ Account created successfully!');
                currentUser = userData;
                localStorage.setItem('currentUser', JSON.stringify(userData));
                showAccountDashboard();

            } catch (error) {
                console.error('Error creating account:', error);
                alert('‚ùå Error creating account. Please try again.');
            }
        }

        // Login user
        async function loginUser() {
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value;

            if (!username || !password) {
                alert('Please enter both username and password');
                return;
            }

            try {
                let user = null;

                if (window.db) {
                    // Query Firebase for user
                    const userQuery = await window.db.collection('users')
                        .where('username', '==', username)
                        .where('password', '==', password)
                        .get();
                    
                    if (!userQuery.empty) {
                        user = userQuery.docs[0].data();
                    }
                } else {
                    // Check localStorage
                    const users = JSON.parse(localStorage.getItem('blogUsers') || '[]');
                    user = users.find(u => u.username === username && u.password === password);
                }

                if (user) {
                    currentUser = user;
                    localStorage.setItem('currentUser', JSON.stringify(user));
                    showAccountDashboard();
                    alert('‚úÖ Login successful!');
                } else {
                    alert('‚ùå Invalid username or password');
                }

            } catch (error) {
                console.error('Error logging in:', error);
                alert('‚ùå Error logging in. Please try again.');
            }
        }

        // Show account dashboard
        function showAccountDashboard() {
            document.getElementById('auth-section').style.display = 'none';
            document.getElementById('account-dashboard').style.display = 'block';
            loadUserProfile();
        }

        // Load user profile data
        function loadUserProfile() {
            if (!currentUser) return;

            document.getElementById('user-display-name').textContent = currentUser.username;
            document.getElementById('user-email').textContent = currentUser.email;
            document.getElementById('user-join-date').textContent = `Member since: ${new Date(currentUser.joinDate).toLocaleDateString()}`;
            
            // Update avatar
            const avatar = document.getElementById('user-avatar');
            if (currentUser.avatar?.type === 'photo' && currentUser.avatar?.photo) {
                avatar.style.backgroundImage = `url(${currentUser.avatar.photo})`;
                avatar.style.background = 'none';
                avatar.textContent = '';
            } else {
                avatar.style.backgroundImage = 'none';
                avatar.style.background = currentUser.avatar?.background || 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                avatar.textContent = currentUser.avatar?.initials || currentUser.username.substring(0, 2).toUpperCase();
            }

            // Load form fields
            document.getElementById('edit-username').value = currentUser.username;
            document.getElementById('edit-email').value = currentUser.email;
            document.getElementById('edit-bio').value = currentUser.bio || '';

            // Load statistics
            loadUserStats();
        }

        // Load user statistics
        async function loadUserStats() {
            try {
                let postsCount = 0;
                let commentsCount = 0;
                let likesReceived = 0;

                if (window.db) {
                    // Count user posts
                    const postsQuery = await window.db.collection('userPosts')
                        .where('author', '==', currentUser.username)
                        .get();
                    postsCount = postsQuery.size;

                    // Count user comments
                    const commentsQuery = await window.db.collection('comments')
                        .where('author', '==', currentUser.username)
                        .get();
                    commentsCount = commentsQuery.size;
                } else {
                    // Count from localStorage
                    const userPosts = JSON.parse(localStorage.getItem('userPosts') || '[]');
                    postsCount = userPosts.filter(post => post.author === currentUser.username).length;

                    const globalComments = JSON.parse(localStorage.getItem('globalComments') || '{}');
                    Object.values(globalComments).forEach(postComments => {
                        commentsCount += postComments.filter(comment => comment.author === currentUser.username).length;
                    });
                }

                document.getElementById('user-posts-count').textContent = postsCount;
                document.getElementById('user-comments-count').textContent = commentsCount;
                document.getElementById('user-likes-received').textContent = likesReceived;

            } catch (error) {
                console.error('Error loading user stats:', error);
            }
        }

        // Update user profile
        async function updateProfile() {
            const newUsername = document.getElementById('edit-username').value.trim();
            const newEmail = document.getElementById('edit-email').value.trim();
            const newBio = document.getElementById('edit-bio').value.trim();

            if (!newUsername || !newEmail) {
                alert('Username and email are required');
                return;
            }

            try {
                currentUser.username = newUsername;
                currentUser.email = newEmail;
                currentUser.bio = newBio;

                if (window.db) {
                    await window.db.collection('users').doc(currentUser.id).update({
                        username: newUsername,
                        email: newEmail,
                        bio: newBio
                    });
                } else {
                    const users = JSON.parse(localStorage.getItem('blogUsers') || '[]');
                    const userIndex = users.findIndex(u => u.id === currentUser.id);
                    if (userIndex !== -1) {
                        users[userIndex] = currentUser;
                        localStorage.setItem('blogUsers', JSON.stringify(users));
                    }
                }

                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                alert('‚úÖ Profile updated successfully!');
                loadUserProfile();

            } catch (error) {
                console.error('Error updating profile:', error);
                alert('‚ùå Error updating profile. Please try again.');
            }
        }

        // Setup avatar editor
        function setupAvatarEditor() {
            const gradientOptions = document.querySelectorAll('.gradient-option');
            gradientOptions.forEach(option => {
                option.addEventListener('click', function() {
                    // Remove previous selection
                    gradientOptions.forEach(o => o.style.border = '3px solid transparent');
                    // Select current
                    this.style.border = '3px solid #4ECDC4';
                    selectedGradient = this.dataset.gradient;
                    updateAvatarPreview();
                });
            });

            document.getElementById('avatar-initials').addEventListener('input', updateAvatarPreview);
        }

        // Update avatar preview
        function updateAvatarPreview() {
            const preview = document.getElementById('avatar-preview');
            
            if (currentAvatarType === 'photo' && uploadedPhotoData) {
                preview.style.backgroundImage = `url(${uploadedPhotoData})`;
                preview.style.background = 'none';
                preview.textContent = '';
            } else {
                const initials = document.getElementById('avatar-initials').value.toUpperCase() || 'HB';
                preview.style.backgroundImage = 'none';
                preview.style.background = selectedGradient;
                preview.textContent = initials.substring(0, 2);
            }
        }

        // Select avatar type
        function selectAvatarType(type) {
            currentAvatarType = type;
            
            // Update button styles
            const gradientBtn = document.getElementById('gradient-avatar-btn');
            const photoBtn = document.getElementById('photo-avatar-btn');
            
            if (type === 'gradient') {
                gradientBtn.style.background = '#4ECDC4';
                gradientBtn.style.border = '2px solid #4ECDC4';
                photoBtn.style.background = 'transparent';
                photoBtn.style.border = '2px solid rgba(255,255,255,0.3)';
                
                document.getElementById('gradient-avatar-section').style.display = 'block';
                document.getElementById('photo-upload-section').style.display = 'none';
            } else {
                photoBtn.style.background = '#4ECDC4';
                photoBtn.style.border = '2px solid #4ECDC4';
                gradientBtn.style.background = 'transparent';
                gradientBtn.style.border = '2px solid rgba(255,255,255,0.3)';
                
                document.getElementById('gradient-avatar-section').style.display = 'none';
                document.getElementById('photo-upload-section').style.display = 'block';
            }
            
            updateAvatarPreview();
        }

        // Handle photo upload
        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validate file type
            if (!file.type.match(/^image\/(jpeg|jpg|png|gif)$/)) {
                alert('‚ùå Please upload a valid image file (JPG, PNG, or GIF)');
                return;
            }
            
            // Validate file size (2MB max)
            if (file.size > 2 * 1024 * 1024) {
                alert('‚ùå File size must be less than 2MB');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    setupPhotoCanvas(img);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // Setup photo canvas for cropping
        function setupPhotoCanvas(img) {
            photoCanvas = document.getElementById('photo-canvas');
            photoContext = photoCanvas.getContext('2d');
            
            // Set canvas size
            const canvasSize = 300;
            photoCanvas.width = canvasSize;
            photoCanvas.height = canvasSize;
            
            // Calculate how to fit image in canvas
            const scale = Math.max(canvasSize / img.width, canvasSize / img.height);
            const scaledWidth = img.width * scale;
            const scaledHeight = img.height * scale;
            const offsetX = (canvasSize - scaledWidth) / 2;
            const offsetY = (canvasSize - scaledHeight) / 2;
            
            // Store image data globally for cropping
            window.originalImage = img;
            window.imageScale = scale;
            window.imageOffsetX = offsetX;
            window.imageOffsetY = offsetY;
            window.scaledWidth = scaledWidth;
            window.scaledHeight = scaledHeight;
            
            // Initialize crop position (centered)
            window.cropX = canvasSize / 2;
            window.cropY = canvasSize / 2;
            window.cropRadius = 120;
            
            // Draw the image and crop overlay
            redrawCanvas();
            
            // Show crop area
            document.getElementById('photo-crop-area').style.display = 'block';
            
            // Add mouse events for dragging
            setupCanvasInteraction();
        }

        // Redraw canvas with image and crop overlay
        function redrawCanvas() {
            const canvasSize = 300;
            
            // Clear canvas
            photoContext.clearRect(0, 0, canvasSize, canvasSize);
            
            // Draw the image
            photoContext.drawImage(
                window.originalImage,
                window.imageOffsetX,
                window.imageOffsetY,
                window.scaledWidth,
                window.scaledHeight
            );
            
            // Draw semi-transparent overlay
            photoContext.save();
            photoContext.fillStyle = 'rgba(0, 0, 0, 0.5)';
            photoContext.fillRect(0, 0, canvasSize, canvasSize);
            
            // Cut out the crop circle
            photoContext.globalCompositeOperation = 'destination-out';
            photoContext.beginPath();
            photoContext.arc(window.cropX, window.cropY, window.cropRadius, 0, 2 * Math.PI);
            photoContext.fill();
            
            photoContext.restore();
            
            // Draw crop circle border
            photoContext.strokeStyle = '#4ECDC4';
            photoContext.lineWidth = 3;
            photoContext.beginPath();
            photoContext.arc(window.cropX, window.cropY, window.cropRadius, 0, 2 * Math.PI);
            photoContext.stroke();
            
            // Draw center dot for dragging reference
            photoContext.fillStyle = '#4ECDC4';
            photoContext.beginPath();
            photoContext.arc(window.cropX, window.cropY, 4, 0, 2 * Math.PI);
            photoContext.fill();
        }

        // Setup canvas interaction (dragging)
        function setupCanvasInteraction() {
            let isDragging = false;
            
            photoCanvas.addEventListener('mousedown', function(e) {
                const rect = photoCanvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                // Check if click is within crop circle
                const dx = x - window.cropX;
                const dy = y - window.cropY;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance <= window.cropRadius) {
                    isDragging = true;
                    photoCanvas.style.cursor = 'move';
                }
            });
            
            photoCanvas.addEventListener('mousemove', function(e) {
                if (!isDragging) return;
                
                const rect = photoCanvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                // Keep crop circle within canvas bounds
                const minX = window.cropRadius;
                const maxX = 300 - window.cropRadius;
                const minY = window.cropRadius;
                const maxY = 300 - window.cropRadius;
                
                window.cropX = Math.max(minX, Math.min(maxX, x));
                window.cropY = Math.max(minY, Math.min(maxY, y));
                
                redrawCanvas();
            });
            
            photoCanvas.addEventListener('mouseup', function() {
                isDragging = false;
                photoCanvas.style.cursor = 'pointer';
            });
            
            photoCanvas.addEventListener('mouseleave', function() {
                isDragging = false;
                photoCanvas.style.cursor = 'pointer';
            });
            
            // Set initial cursor
            photoCanvas.style.cursor = 'pointer';
        }

        // Crop photo with current position
        function cropPhoto() {
            // Create a new canvas for the cropped result
            const resultCanvas = document.createElement('canvas');
            const resultContext = resultCanvas.getContext('2d');
            const cropSize = window.cropRadius * 2;
            
            resultCanvas.width = cropSize;
            resultCanvas.height = cropSize;
            
            // Calculate source coordinates on the original image
            const sourceX = (window.cropX - window.imageOffsetX - window.cropRadius) / window.imageScale;
            const sourceY = (window.cropY - window.imageOffsetY - window.cropRadius) / window.imageScale;
            const sourceSize = cropSize / window.imageScale;
            
            // Draw the cropped portion
            resultContext.drawImage(
                window.originalImage,
                sourceX, sourceY, sourceSize, sourceSize,
                0, 0, cropSize, cropSize
            );
            
            // Convert to base64
            uploadedPhotoData = resultCanvas.toDataURL('image/jpeg', 0.8);
            
            // Hide crop area
            document.getElementById('photo-crop-area').style.display = 'none';
            
            // Update preview
            updateAvatarPreview();
            
            alert('‚úÖ Photo cropped and ready! Click "Save Avatar" to apply.');
        }

        // Cancel photo upload
        function cancelPhotoUpload() {
            uploadedPhotoData = null;
            document.getElementById('photo-crop-area').style.display = 'none';
            document.getElementById('avatar-photo-input').value = '';
            updateAvatarPreview();
        }

        // Edit avatar
        function editAvatar() {
            if (!currentUser) return;
            
            document.getElementById('avatar-modal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            
            // Set current values based on avatar type
            if (currentUser.avatar?.type === 'photo' && currentUser.avatar?.photo) {
                currentAvatarType = 'photo';
                uploadedPhotoData = currentUser.avatar.photo;
                selectAvatarType('photo');
            } else {
                currentAvatarType = 'gradient';
                selectedGradient = currentUser.avatar?.background || 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                document.getElementById('avatar-initials').value = currentUser.avatar?.initials || currentUser.username.substring(0, 2).toUpperCase();
                selectAvatarType('gradient');
            }
            
            updateAvatarPreview();
        }

        // Save avatar
        async function saveAvatar() {
            // Check if user is logged in
            if (!currentUser) {
                alert('‚ùå Please log in first to save your avatar');
                return;
            }
            
            if (currentAvatarType === 'photo') {
                if (!uploadedPhotoData) {
                    alert('‚ùå Please upload and crop a photo first');
                    return;
                }
                
                currentUser.avatar = {
                    type: 'photo',
                    photo: uploadedPhotoData,
                    background: null,
                    initials: null
                };
            } else {
                const initials = document.getElementById('avatar-initials').value.toUpperCase() || 'HB';
                
                currentUser.avatar = {
                    type: 'gradient',
                    background: selectedGradient,
                    initials: initials.substring(0, 2),
                    photo: null
                };
            }

            try {
                if (window.db) {
                    await window.db.collection('users').doc(currentUser.id).update({
                        avatar: currentUser.avatar
                    });
                } else {
                    const users = JSON.parse(localStorage.getItem('blogUsers') || '[]');
                    const userIndex = users.findIndex(u => u.id === currentUser.id);
                    if (userIndex !== -1) {
                        users[userIndex] = currentUser;
                        localStorage.setItem('blogUsers', JSON.stringify(users));
                    }
                }

                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                loadUserProfile();
                closeAvatarModal();
                alert('‚úÖ Avatar updated successfully!');

            } catch (error) {
                console.error('Error saving avatar:', error);
                alert('‚ùå Error saving avatar: ' + error.message);
            }
        }

        // Close avatar modal
        function closeAvatarModal() {
            document.getElementById('avatar-modal').style.display = 'none';
            document.body.style.overflow = '';
            
            // Clean up photo upload state
            document.getElementById('photo-crop-area').style.display = 'none';
            document.getElementById('avatar-photo-input').value = '';
            uploadedPhotoData = null;
        }

        // Generate avatar HTML for any user (can be used globally)
        function generateAvatarHTML(avatar, username, size = 40) {
            if (avatar?.type === 'photo' && avatar?.photo) {
                return `<div style="width: ${size}px; height: ${size}px; border-radius: 50%; background-image: url(${avatar.photo}); background-size: cover; background-position: center; border: 2px solid rgba(255,255,255,0.3);"></div>`;
            } else {
                const background = avatar?.background || 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                const initials = avatar?.initials || username.substring(0, 2).toUpperCase();
                const fontSize = Math.max(12, size * 0.4);
                return `<div style="width: ${size}px; height: ${size}px; border-radius: 50%; background: ${background}; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: ${fontSize}px; border: 2px solid rgba(255,255,255,0.3);">${initials}</div>`;
            }
        }

        // Make the function available globally
        window.generateAvatarHTML = generateAvatarHTML;

        // Change password
        function changePassword() {
            const newPassword = prompt('Enter new password:');
            if (!newPassword) return;
            
            if (newPassword.length < 6) {
                alert('Password must be at least 6 characters long');
                return;
            }

            // Confirm password
            const confirmPassword = prompt('Confirm new password:');
            if (newPassword !== confirmPassword) {
                alert('Passwords do not match');
                return;
            }

            // Update password
            currentUser.password = newPassword;
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            alert('‚úÖ Password changed successfully!');
        }

        // Logout user
        function logoutUser() {
            if (confirm('Are you sure you want to logout?')) {
                currentUser = null;
                localStorage.removeItem('currentUser');
                document.getElementById('auth-section').style.display = 'block';
                document.getElementById('account-dashboard').style.display = 'none';
                showLoginForm();
                
                // Clear form fields
                document.getElementById('login-username').value = '';
                document.getElementById('login-password').value = '';
            }
        }

        // Helper functions
        function generateUserId() {
            return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        async function checkUsernameExists(username) {
            if (window.db) {
                const userQuery = await window.db.collection('users')
                    .where('username', '==', username)
                    .get();
                return !userQuery.empty;
            } else {
                const users = JSON.parse(localStorage.getItem('blogUsers') || '[]');
                return users.some(u => u.username === username);
            }
        }

        // Make functions globally available
        window.checkUserSession = checkUserSession;
        window.getCurrentUser = () => currentUser;
    </script>

    <style>
        .auth-form {
            max-width: 400px;
            margin: 0 auto;
        }
        
        .profile-avatar:hover {
            transform: scale(1.05);
            transition: all 0.3s ease;
        }
        
        .gradient-option:hover {
            transform: scale(1.1);
            transition: all 0.2s ease;
        }
        
        #avatar-initials {
            text-transform: uppercase;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-number {
            display: block;
            font-size: 2em;
            font-weight: bold;
            color: #4ECDC4;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: rgba(255,255,255,0.8);
            font-size: 0.9em;
            text-transform: uppercase;
        }
    </style>
</body>
</html>
