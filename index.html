<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Harvey's Blog</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- Complete favicon set -->
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="192x192" href="android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="android-chrome-512x512.png">
    <link rel="shortcut icon" href="favicon.ico">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <!-- Bouncing animations with explosion -->
    <div id="bouncing-container">
        <img id="kumamon-image" src="images/kumamon.png" alt="Bouncing Kumamon">
        <img id="babyrat-image" src="images/babyrat.png" alt="Bouncing Baby Rat">
        <div id="explosion-container" style="display: none; position: fixed; z-index: 1000;">
            <img id="explosion-image" src="images/explosion-kumamon.png" alt="Explosion">
        </div>
    </div>
    
    <header>
        <div class="container">
            <h1>Harvey's Blog</h1>
            <nav>
                <a href="index.html">Home</a>
                <a href="travel.html">Travel</a>
                <a href="about.html">About</a>
                <a href="write.html">Write</a>
                <a href="my-posts.html" style="color: #fbbf24;">üìù My Posts</a>
                <a href="contact.html">Contact</a>
                <a href="admin.html" style="color: #fbbf24;">Admin</a>
            </nav>
            <div class="header-controls">
                <!-- Comment Notification -->
                <div id="comment-notification" class="notification" style="display: none;">
                    0 new comments
                </div>
                <!-- Page View Counter -->
                <div class="view-counter">
                    <span id="view-count">Loading views...</span>
                </div>
                <div class="theme-toggle">
                    <span>üåô</span>
                    <label class="switch">
                        <input type="checkbox" id="theme-toggle">
                        <span class="slider round"></span>
                    </label>
                    <span>‚òÄÔ∏è</span>
                </div>
                <div class="animation-toggle">
                    <span>Animation</span>
                    <label class="switch">
                        <input type="checkbox" id="animation-toggle" checked>
                        <span class="slider round"></span>
                    </label>
                </div>
            </div>
        </div>
    </header>
    <main class="container">
        <!-- Search and Filter Section -->
        <div class="blog-controls">
            <div class="search-container">
                <input type="text" id="search-input" placeholder="Search posts..." />
                <button id="search-btn">üîç</button>
            </div>
            <div class="filter-container">
                <select id="category-filter">
                    <option value="all">All Categories</option>
                    <option value="blog">Blog Posts</option>
                    <option value="personal">Personal</option>
                    <option value="tech">Technology</option>
                </select>
                <select id="sort-filter">
                    <option value="newest">Newest First</option>
                    <option value="oldest">Oldest First</option>
                    <option value="popular">Most Popular</option>
                </select>
            </div>
        </div>

        <div class="main-content">
            <div class="posts-section">
                <!-- User Posts Section -->
                <div id="user-posts-section">
                    <h2 style="color: white; margin-bottom: 20px; padding: 15px; background: rgba(53, 66, 74, 0.8); border-radius: 10px; backdrop-filter: blur(10px);">
                        üìù Community Posts
                    </h2>
                    <div id="user-posts-container">
                        <!-- User posts will be loaded here -->
                    </div>
                </div>
                
                <!-- Original Harvey's Posts -->
                <div id="harvey-posts-section">
                    <h2 style="color: white; margin-bottom: 20px; padding: 15px; background: rgba(53, 66, 74, 0.8); border-radius: 10px; backdrop-filter: blur(10px);">
                        üì∞ Harvey's Posts
                    </h2>
                </div>
                <!-- Updated blog posts with new features -->
                <div class="post" data-category="personal">
                    <h2>I will be the special one</h2>
                    <p class="post-meta">July 2, 2024 ‚Ä¢ <span class="view-count" id="view-special-one">Loading views...</span> ‚Ä¢ <span class="category-tag personal">Personal</span></p>
                    <p>I had a discussion with Bok Han about my desire to become a special person. He asked me to define what it means to be special. To ensure I don't forget, I'm noting down some concepts here.</p>
                    <div class="post-actions">
                        <a href="posts/2024-07-02-i-will-be-the-special-one.html" class="read-more">Read More</a>
                        <button class="like-btn" data-post="special-one">
                            <span class="heart">‚ô°</span>
                            <span class="like-count">0</span>
                        </button>
                        <div class="share-buttons">
                            <button class="share-btn" data-platform="twitter">üê¶</button>
                            <button class="share-btn" data-platform="facebook">üìò</button>
                            <button class="share-btn" data-platform="copy">üìã</button>
                        </div>
                    </div>
                </div>
                
                <div class="post" data-category="personal">
                    <h2>Future Fear</h2>
                    <p class="post-meta">October 26, 2024 ‚Ä¢ <span class="view-count" id="view-future-fear">Loading views...</span> ‚Ä¢ <span class="category-tag personal">Personal</span></p>
                    <p>I've been reflecting on the kind of life I want to lead while I'm in Korea. Observing those who are 25 or 26 and still in their third year of university, I realize that at 19, I'm the youngest among the exchange students. This is quite normal in Hong Kong, but it makes me wonder what my life will be like at their age.</p>
                    <div class="post-actions">
                        <a href="posts/2024-10-26-future-fear.html" class="read-more">Read More</a>
                        <button class="like-btn" data-post="future-fear">
                            <span class="heart">‚ô°</span>
                            <span class="like-count">0</span>
                        </button>
                        <div class="share-buttons">
                            <button class="share-btn" data-platform="twitter">üê¶</button>
                            <button class="share-btn" data-platform="facebook">üìò</button>
                            <button class="share-btn" data-platform="copy">üìã</button>
                        </div>
                    </div>
                </div>

                <!-- Dynamic posts -->
                <div id="posts-container">
                    <!-- Posts will be loaded here by JavaScript -->
                </div>
            </div>

            <!-- Sidebar -->
            <div class="sidebar">
                <div class="sidebar-widget">
                    <h3>Recent Posts</h3>
                    <div id="recent-posts">
                        <!-- Recent posts will be loaded here -->
                    </div>
                </div>
                
                <div class="sidebar-widget">
                    <h3>Popular Tags</h3>
                    <div class="tag-cloud">
                        <span class="tag">personal</span>
                        <span class="tag">motivation</span>
                        <span class="tag">life</span>
                        <span class="tag">goals</span>
                        <span class="tag">reflection</span>
                    </div>
                </div>
                
                <div class="sidebar-widget">
                    <h3>Blog Stats</h3>
                    <div class="stats">
                        <div class="stat-item">
                            <span class="stat-number" id="total-posts">2</span>
                            <span class="stat-label">Posts</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="total-views">241</span>
                            <span class="stat-label">Views</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="total-likes">42</span>
                            <span class="stat-label">Likes</span>
                        </div>
                    </div>
                </div>
                
                <!-- Bokhan Sir's Special Button -->
                <div class="sidebar-widget">
                    <h3>üéØ Special Feature</h3>
                    <div style="text-align: center;">
                        <button class="hexagon-button" onclick="showBokhanMessage()">
                            BUTTON
                        </button>
                        <p style="font-size: 0.8em; color: rgba(255,255,255,0.7); margin-top: 10px; font-style: italic;">
                            Inspired by Bokhan Sir ‚ú®
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <footer>
        <div class="footer-content">
            <p>&copy; 2024 Harvey's Blog. All rights reserved.</p>
            <div class="website-stats">
                <div class="running-time">
                    <span class="stats-label">Website running for:</span>
                    <span id="website-uptime" class="stats-value">Loading...</span>
                </div>
            </div>
        </div>
    </footer>
    
    <script src="js/main.js"></script>
    <script src="js/animations.js"></script>
    <script src="js/bounce.js"></script>
    <script src="js/features.js"></script>
    <script src="js/firebase-config.js"></script>
    <script src="js/global-features.js"></script>
    
    <script>
        // Load user posts on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Add a small delay to ensure Firebase is fully initialized
            setTimeout(() => {
                loadUserPostsOnMain();
                loadPostViewCounts();
                updateSidebarStats();
            }, 1000);
        });

        // Bokhan Sir's Special Button Function
        function showBokhanMessage() {
            // Remove any existing message
            const existingMessage = document.querySelector('.bokhan-message');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            // Create new message element
            const messageDiv = document.createElement('div');
            messageDiv.className = 'bokhan-message';
            messageDiv.innerHTML = `
                <div>
                    This button is being pressed<br>
                    by Bokhan Sir
                </div>
            `;
            
            // Add to page
            document.body.appendChild(messageDiv);
            
            // Auto-remove after 3 seconds with fade animation
            setTimeout(() => {
                messageDiv.classList.add('fade-out');
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }
                }, 300);
            }, 3000);
            
            // Add click-to-dismiss
            messageDiv.addEventListener('click', () => {
                messageDiv.classList.add('fade-out');
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }
                }, 300);
            });
        }

        // Load individual post view counts
        async function loadPostViewCounts() {
            const posts = [
                { id: 'special-one', elementId: 'view-special-one' },
                { id: 'future-fear', elementId: 'view-future-fear' }
            ];
            
            for (const post of posts) {
                const element = document.getElementById(post.elementId);
                if (element) {
                    try {
                        let viewCount = 0;
                        
                        if (window.db) {
                            const viewDoc = await window.db.collection('postViews').doc(post.id).get();
                            if (viewDoc.exists) {
                                viewCount = viewDoc.data().count || 0;
                            }
                        } else {
                            const views = JSON.parse(localStorage.getItem('postViews') || '{}');
                            viewCount = views[post.id] || 0;
                        }
                        
                        element.textContent = `${viewCount} views`;
                    } catch (error) {
                        console.error('Error loading view count for', post.id, ':', error);
                        element.textContent = '0 views';
                    }
                }
            }
        }

        // Update sidebar statistics
        async function updateSidebarStats() {
            try {
                let totalViews = 0;
                let totalLikes = 0;
                
                if (window.db) {
                    // Get total post views
                    const postViewsSnapshot = await window.db.collection('postViews').get();
                    postViewsSnapshot.forEach(doc => {
                        totalViews += doc.data().count || 0;
                    });
                    
                    // Get total page views
                    const pageViewsSnapshot = await window.db.collection('views').get();
                    pageViewsSnapshot.forEach(doc => {
                        totalViews += doc.data().count || 0;
                    });
                    
                    // Get total likes
                    const likesSnapshot = await window.db.collection('likes').get();
                    likesSnapshot.forEach(doc => {
                        totalLikes += doc.data().count || 0;
                    });
                } else {
                    // Local storage fallback
                    const postViews = JSON.parse(localStorage.getItem('postViews') || '{}');
                    const pageViews = JSON.parse(localStorage.getItem('pageViews') || '{}');
                    const likes = JSON.parse(localStorage.getItem('postLikes') || '{}');
                    
                    totalViews = Object.values(postViews).reduce((sum, count) => sum + count, 0) +
                                Object.values(pageViews).reduce((sum, count) => sum + count, 0);
                    totalLikes = Object.values(likes).reduce((sum, count) => sum + count, 0);
                }
                
                // Update sidebar stats
                const totalViewsEl = document.getElementById('total-views');
                const totalLikesEl = document.getElementById('total-likes');
                
                if (totalViewsEl) totalViewsEl.textContent = totalViews;
                if (totalLikesEl) totalLikesEl.textContent = totalLikes;
                
            } catch (error) {
                console.error('Error updating sidebar stats:', error);
            }
        }

        async function loadUserPostsOnMain() {
            console.log('üîç Loading user posts...');
            console.log('Firebase initialized:', window.firebaseInitialized);
            console.log('Database available:', window.db !== null);
            
            try {
                let userPosts = [];
                
                // Try to load from Firebase first
                if (window.db) {
                    console.log('üìä Querying Firebase for user posts...');
                    const snapshot = await window.db.collection('userPosts')
                        .where('status', '==', 'published')
                        .orderBy('publishedAt', 'desc')
                        .limit(10)
                        .get();
                    
                    console.log('üìä Firebase query completed. Documents found:', snapshot.docs.length);
                    
                    userPosts = snapshot.docs.map(doc => {
                        const data = doc.data();
                        console.log('üìÑ Document data:', {
                            id: doc.id,
                            title: data.title,
                            status: data.status,
                            publishedAt: data.publishedAt
                        });
                        return {
                            id: doc.id,
                            ...data
                        };
                    });
                } else {
                    console.log('üìä Using localStorage fallback...');
                    // Fallback to localStorage
                    const allPosts = JSON.parse(localStorage.getItem('userPosts') || '[]');
                    userPosts = allPosts
                        .filter(post => post.status === 'published')
                        .sort((a, b) => new Date(b.publishedAt) - new Date(a.publishedAt))
                        .slice(0, 10);
                    console.log('üìä localStorage posts found:', userPosts.length);
                }

                console.log('‚úÖ Total user posts to display:', userPosts.length);
                displayUserPostsOnMain(userPosts);
                updateBlogStats(userPosts);
                
            } catch (error) {
                console.error('‚ùå Error loading user posts:', error);
                console.log('üîÑ Attempting to use query without orderBy...');
                
                try {
                    // Fallback: try without orderBy if index doesn't exist
                    if (window.db) {
                        const snapshot = await window.db.collection('userPosts')
                            .where('status', '==', 'published')
                            .limit(10)
                            .get();
                        
                        const userPosts = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        
                        // Sort manually
                        userPosts.sort((a, b) => new Date(b.publishedAt) - new Date(a.publishedAt));
                        
                        console.log('‚úÖ Fallback query successful:', userPosts.length);
                        displayUserPostsOnMain(userPosts);
                        updateBlogStats(userPosts);
                    } else {
                        throw new Error('No Firebase connection');
                    }
                } catch (fallbackError) {
                    console.error('‚ùå Fallback query also failed:', fallbackError);
                    document.getElementById('user-posts-container').innerHTML = 
                        '<p style="color: rgba(255,255,255,0.8); text-align: center; padding: 20px;">Error loading posts. <a href="write.html" style="color: #4ECDC4;">Write a new post</a><br><small>Index may need to be created. Check admin panel.</small></p>';
                }
            }
        }

        function displayUserPostsOnMain(posts) {
            const container = document.getElementById('user-posts-container');
            
            if (posts.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; background: rgba(255,255,255,0.1); border-radius: 10px; backdrop-filter: blur(10px);">
                        <h3 style="color: white; margin-bottom: 15px;">‚úçÔ∏è No community posts yet</h3>
                        <p style="color: rgba(255,255,255,0.8); margin-bottom: 20px;">Be the first to share your thoughts with the community!</p>
                        <a href="write.html" style="background: rgba(0,123,255,0.8); color: white; padding: 12px 24px; border-radius: 25px; text-decoration: none; font-weight: bold;">Write Your First Post</a>
                    </div>
                `;
                return;
            }

            let postsHtml = '';
            posts.forEach(post => {
                const publishDate = new Date(post.publishedAt).toLocaleDateString();
                const excerpt = post.excerpt || post.content.substring(0, 150) + '...';
                
                postsHtml += `
                    <div class="post user-post" data-category="${post.category}" style="border-left: 4px solid #4ECDC4;">
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <div style="width: 30px; height: 30px; border-radius: 50%; background: ${post.authorAvatar?.backgroundColor || '#4ECDC4'}; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; margin-right: 10px;">
                                ${post.authorAvatar?.initials || post.author.substring(0, 2).toUpperCase()}
                            </div>
                            <span style="color: rgba(255,255,255,0.9); font-weight: 500;">by ${post.author}</span>
                        </div>
                        <h2>${post.title}</h2>
                        <p class="post-meta">${publishDate} ‚Ä¢ <span class="category-tag ${post.category}">${post.category}</span> ${post.featured ? '‚Ä¢ <span style="color: #ffd700;">‚≠ê Featured</span>' : ''}</p>
                        <p>${excerpt}</p>
                        <div class="post-actions">
                            <button onclick="viewUserPost('${post.id}')" class="read-more" style="background: rgba(76, 205, 196, 0.8);">Read More</button>
                            <button class="like-btn" data-post="user-${post.id}">
                                <span class="heart">‚ô°</span>
                                <span class="like-count">0</span>
                            </button>
                            <div class="share-buttons">
                                <button class="share-btn" data-platform="copy" onclick="shareUserPost('${post.id}')">üìã</button>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = postsHtml;
        }

        function viewUserPost(postId) {
            const allPosts = JSON.parse(localStorage.getItem('userPosts') || '[]');
            const post = allPosts.find(p => p.id === postId);
            
            if (!post) {
                alert('Post not found.');
                return;
            }
            
            // Create modal for viewing full post
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.9); backdrop-filter: blur(5px); z-index: 1000; 
                display: flex; align-items: center; justify-content: center; padding: 20px;
                overflow-y: auto;
            `;
            
            modal.innerHTML = `
                <div style="background: rgba(53, 66, 74, 0.95); backdrop-filter: blur(20px); border-radius: 20px; border: 2px solid rgba(255, 255, 255, 0.2); padding: 40px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
                        <h1 style="color: white; flex: 1; margin-right: 20px; font-size: 2em;">${post.title}</h1>
                        <button onclick="this.closest('div').parentElement.remove()" style="background: rgba(220,53,69,0.8); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 20px;">√ó</button>
                    </div>
                    <div style="display: flex; align-items: center; margin-bottom: 20px;">
                        <div style="width: 40px; height: 40px; border-radius: 50%; background: ${post.authorAvatar?.backgroundColor || '#4ECDC4'}; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; margin-right: 15px;">
                            ${post.authorAvatar?.initials || post.author.substring(0, 2).toUpperCase()}
                        </div>
                        <div>
                            <div style="color: white; font-weight: 500;">${post.author}</div>
                            <div style="color: rgba(255,255,255,0.7); font-size: 14px;">${new Date(post.publishedAt).toLocaleDateString()} ‚Ä¢ ${post.category}</div>
                        </div>
                    </div>
                    ${post.excerpt ? `<div style="background: rgba(76, 205, 196, 0.2); padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #4ECDC4;"><p style="color: white; font-style: italic; margin: 0;">${post.excerpt}</p></div>` : ''}
                    <div style="background: rgba(255,255,255,0.1); padding: 30px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.2);">
                        <div style="color: white; line-height: 1.8; font-size: 16px; white-space: pre-wrap;">${post.content}</div>
                    </div>
                    <div style="margin-top: 20px; text-align: center;">
                        <button onclick="this.closest('div').parentElement.remove()" style="background: rgba(108, 117, 125, 0.8); color: white; border: none; padding: 12px 24px; border-radius: 25px; cursor: pointer; font-weight: bold;">Close</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Prevent body scroll
            document.body.style.overflow = 'hidden';
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                    document.body.style.overflow = '';
                }
            });
        }

        function shareUserPost(postId) {
            const url = window.location.href + '#post-' + postId;
            navigator.clipboard.writeText(url).then(() => {
                alert('üîó Post link copied to clipboard!');
            }).catch(() => {
                alert('Unable to copy link. Please copy manually: ' + url);
            });
        }

        function updateBlogStats(userPosts) {
            const totalPostsEl = document.getElementById('total-posts');
            const originalPosts = 2; // Harvey's original posts
            if (totalPostsEl) {
                totalPostsEl.textContent = originalPosts + userPosts.length;
            }
        }
    </script>
</body>
</html>